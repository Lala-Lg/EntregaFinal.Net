@page "/IniciarSesion"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using SGE.Aplicacion.Servicios
@using SGE.Aplicacion.Entidades 
@inject NavigationManager Navegador
@inject CasoDeUsoObtenerUsuario CasoDeUsoObtenerUsuario
@inject CasoDeUsoObtenerListaUsuarios CasoDeUsoObtenerListaUsuarios
@inject SGE.Aplicacion.Servicios.HashService HashService

<h3>Iniciar Sesión</h3>

<form>
    <p>Email: <input placeholder="Email" @bind="_correoElectronico" class="form-control" required type="email"></p>
    <p>Contraseña: <input placeholder="Contraseña" @bind="_password" type="password" class="form-control"></p>
</form>

<button class="btn btn-primary" @onclick="Iniciar">Iniciar Sesión</button>

@if (!string.IsNullOrEmpty(_mensajeError))
{
    <p><em>Loading...</em></p>
}

@code {
    private string _correoElectronico = string.Empty;
    private string _password = string.Empty;
    private string _mensajeError = string.Empty;
    private List<Usuario> _usuarios = new List<Usuario>();

    protected void Iniciar()
    {
        // Obtener todos los usuarios
        _usuarios = CasoDeUsoObtenerListaUsuarios.Ejecutar();

        // Buscar el usuario por email utilizando LINQ
        var usuarioEncontrado = _usuarios.FirstOrDefault(u => u.CorreoElectronico == _correoElectronico);

        if (usuarioEncontrado != null)
        {
            // Verificar la contraseña

            if (HashService.VerifyHash(_password, usuarioEncontrado.HashContraseña, usuarioEncontrado.SalContraseña))
            {
                // Redirigir a la página principal o a donde sea necesario
                Navegador.NavigateTo("/dashboard");
            }
            else
            {
                _mensajeError = "La contraseña ingresada es incorrecta. Contactar al soporte técnico.";
            }
        }
        else
        {
            _mensajeError = "El email ingresado no está registrado. Por favor, registre una cuenta o contacte al soporte técnico.";
        }
    }
}